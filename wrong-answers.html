<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python答题挑战 - 错题集</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        :root {
            --title-vertical-offset: 0px; /* 可调节的垂直偏移量参数 */
        }
        
        /* 全局滚动设置 */
        html, body {
            overflow-x: hidden; /* 防止水平滚动条 */
            overflow-y: auto; /* 允许垂直滚动 */
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        * {
            box-sizing: border-box; /* 确保所有元素都使用border-box盒模型 */
            max-width: 100vw; /* 确保元素不超过视口宽度 */
        }
        
        /* 强制阻止水平滚动条 */
        body::-webkit-scrollbar-horizontal {
            display: none;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden; /* 防止水平滚动条 */
        }
        
        header {
            text-align: center;
            margin-bottom: 15px;
            margin-top: 40px; /* 添加顶部间距 */
        }
        
        h1 {
            position: relative;
            z-index: 1;
            color: #fff;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            display: inline-block;
        }
        
        /* 移除标题的黑色矩形长条 */
        h1::before, h1::after {
            display: none; /* 彻底移除标题的伪元素 */
        }
        
        .title-glow {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: radial-gradient(circle at center, rgba(255, 159, 10, 0.8) 0%, rgba(255, 159, 10, 0) 70%);
            filter: blur(10px);
            opacity: 0;
            z-index: -1;
            animation: glow-pulse 4s ease-in-out infinite;
        }
        
        @keyframes glow-pulse {
            0% {
                opacity: 0.2;
                transform: scale(0.8);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.1);
            }
            100% {
                opacity: 0.2;
                transform: scale(0.8);
            }
        }
        
        .subtitle {
            color: var(--text-light);
            font-size: 1.3rem;
            margin-bottom: 20px;
        }
        
        /* 错题集大容器样式 */
        .wrong-answers-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            margin: 0 auto 30px; /* 将底部边距从60px减少到30px */
            position: relative;
            max-height: calc(75vh + 50px); /* 从80px减少到50px */
            width: 70%;
            max-width: 100%; /* 确保不超过父容器宽度 */
            overflow: hidden; /* 改为hidden防止出现自身的滚动条 */
            isolation: isolate;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.08); /* 添加边框替代渐变边框效果 */
        }
        
        /* 彻底移除渐变背景 */
        .wrong-answers-container::before,
        .wrong-answers-container::after {
            display: none !important; /* 强制移除渐变背景 */
        }
        
        /* 错题集内容区域 */
        .wrong-answers-content {
            height: 100%;
            max-height: calc(75vh - 10px); /* 调整内容区域高度 */
            overflow-y: auto !important; /* 只在内容区域保留垂直滚动条 */
            overflow-x: hidden !important; /* 防止水平滚动条 */
            padding-right: 15px;
            padding-bottom: 20px;
            width: 100%; /* 确保宽度不超过父容器 */
        }
        
        /* 确保滚动条显示样式 */
        .wrong-answers-container::-webkit-scrollbar,
        #wrongAnswersContent::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .wrong-answers-container::-webkit-scrollbar-thumb,
        #wrongAnswersContent::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }
        
        .wrong-answers-container::-webkit-scrollbar-thumb:hover,
        #wrongAnswersContent::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .wrong-answers-container::-webkit-scrollbar-track,
        #wrongAnswersContent::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }
        
        /* 调试信息样式 */
        .debug-info {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.9rem;
            color: #30d158;
        }
        
        /* 内容包装器 */
        .content-wrapper {
            position: relative;
            z-index: 1;
            width: 100%; /* 确保宽度不超过父容器 */
        }
        
        .wrong-answer-card {
            background: rgba(45, 45, 50, 0.5);
            border-radius: 18px;
            padding: 15px; /* 从20px减少到15px使内容更紧凑 */
            margin-bottom: 20px; /* 从25px减少到20px使卡片间距更紧凑 */
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            overflow: hidden;
            word-wrap: break-word; /* 确保长文本会自动换行 */
            width: 100%; /* 确保宽度不超过父容器 */
        }
        
        .wrong-answer-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #ff9f0a, #ff375f, #bf5af2);
            opacity: 0.5;
        }
        
        .wrong-answer-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        /* 题目标题样式 */
        .question-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-color);
            line-height: 1.5; /* 增加行高使多行文本更易读 */
            word-wrap: break-word; /* 确保长文本自动换行 */
        }
        
        /* 选项样式 */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 6px; /* 从8px减少到6px使选项间距更紧凑 */
            margin: 12px 0; /* 从16px减少到12px */
            padding: 8px;
            background: rgba(45, 45, 50, 0.4);
            border-radius: 8px;
            width: 100%;
            max-width: 100%;
        }
        
        .option-item {
            padding: 8px 12px;
            border-radius: 6px;
            background: rgba(50, 50, 55, 0.5);
            border: 1px solid var(--border-color);
            line-height: 1.4;
        }
        
        .option-item.user-selected {
            border-color: #FF454A;
            background-color: rgba(255, 69, 58, 0.1);
        }
        
        .option-item.correct {
            border-color: var(--status-completed);
            background-color: rgba(50, 215, 75, 0.1);
        }
        
        .your-answer, .correct-answer {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(45, 45, 50, 0.4);
        }
        
        .your-answer {
            color: var(--text-light);
            border-left: 3px solid #FF454A;
        }
        
        .correct-answer {
            color: var(--status-completed);
            border-left: 3px solid var(--status-completed);
            margin-bottom: 15px;
        }
        
        .explanation {
            margin-top: 15px;
            padding: 12px;
            background: rgba(50, 50, 55, 0.3);
            border-radius: 8px;
            color: var(--text-light);
            line-height: 1.5;
        }
        
        /* 底部按钮 */
        .actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        .action-button {
            padding: 14px 32px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
            background: linear-gradient(135deg, #FF9F0A, #FF375F);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
            margin: 20px auto;
            box-shadow: 0 4px 15px rgba(255, 159, 10, 0.2);
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 159, 10, 0.3);
        }
        
        /* 返回按钮样式 */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 18px;
            background: linear-gradient(135deg, #FF9F0A, #FF375F);
            color: white;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255, 55, 95, 0.3);
            z-index: 100;
            display: flex;
            align-items: center;
        }
        
        .back-button:before {
            content: '◀︎';
            margin-right: 8px;
            font-size: 1.2rem;
        }
        
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 55, 95, 0.5);
            background: linear-gradient(135deg, #FFB340, #FF5277);
        }
        
        /* 标题流光效果 */
        h1::before, h1::after {
            content: "";
            position: absolute;
            top: -10px;
            left: -30px;
            width: calc(100% + 60px);
            height: calc(100% + 20px);
            background: linear-gradient(
                45deg,
                transparent 0%,
                rgba(255, 159, 10, 0.4) 35%,
                rgba(191, 90, 242, 0.4) 50%,
                rgba(64, 200, 224, 0.4) 65%,
                transparent 100%
            );
            background-size: 250% 250%;
            mix-blend-mode: screen;
            z-index: 1;
            animation: title-flow 6s ease-in-out infinite;
            pointer-events: none;
            border-radius: 40%;
            filter: blur(8px);
            transform: skew(-5deg, 2deg);
        }
        
        h1::after {
            width: calc(100% + 80px);
            left: -40px;
            top: -5px;
            height: calc(100% + 15px);
            filter: blur(12px);
            opacity: 0.7;
            animation-duration: 9s;
            animation-direction: reverse;
            mix-blend-mode: screen;
            transform: skew(8deg, -3deg);
            border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
        }
        
        @keyframes title-flow {
            0% {
                background-position: 0% 50%;
                border-radius: 40% 60% 60% 40% / 40% 40% 60% 60%;
            }
            50% {
                background-position: 100% 50%;
                border-radius: 60% 40% 40% 60% / 60% 60% 40% 40%;
            }
            100% {
                background-position: 0% 50%;
                border-radius: 40% 60% 60% 40% / 40% 40% 60% 60%;
            }
        }
        
        /* 增加一个额外的光晕效果 */
        .title-glow {
            position: absolute;
            width: 200%;
            height: 150%;
            top: -25%;
            left: -50%;
            background: radial-gradient(
                ellipse at center,
                rgba(255, 159, 10, 0.2) 0%,
                rgba(191, 90, 242, 0.2) 30%,
                rgba(64, 200, 224, 0.2) 60%,
                transparent 80%
            );
            filter: blur(35px);
            animation: title-glow 12s ease-in-out infinite alternate;
            z-index: 0;
            pointer-events: none;
        }
        
        @keyframes title-glow {
            0% {
                opacity: 0.5;
                transform: scale(0.95) translateY(3px);
                border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
            }
            100% {
                opacity: 0.7;
                transform: scale(1.05) translateY(-3px);
                border-radius: 70% 30% 30% 70% / 70% 70% 30% 30%;
            }
        }
        
        .no-wrong-answers {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
            font-size: 1.2rem;
        }
        
        /* 关卡选择器的基本样式 */
        .level-selector {
            position: fixed;
            left: -190px; /* 只露出50px */
            top: 180px;
            width: 230px; /* 增加选择器宽度 */
            background: #2A2A30;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-left: none;
            border-radius: 0 8px 8px 0;
            padding: 15px;
            box-shadow: 3px 0 10px rgba(0, 0, 0, 0.5);
            transition: left 0.3s ease;
            z-index: 990;
        }
        
        /* 黄色书签 - 使用伪元素实现 */
        .level-selector::after {
            content: '';
            position: absolute;
            top: 0;
            right: -15px; /* 位于选择器右侧 */
            width: 40px;
            height: 100%;
            background-color: #ffbb00d8; /* 明亮的黄色 */
            border-radius: 0 8px 8px 0;
            box-shadow: 0 0 10px rgba(255, 204, 0, 0.6);
            z-index: 991;
        }
        
        /* 金属条纹 - 使用多个伪元素实现 */
        .level-selector::before {
            content: '';
            position: absolute;
            top: 15%;
            right: -40px;
            width: 2px;
            height: 70%;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 8px 0 0 rgba(255, 255, 255, 0.8),
                        16px 0 0 rgba(255, 255, 255, 0.8),
                        24px 0 0 rgba(255, 255, 255, 0.8);
            z-index: 992;
        }
        
        /* 悬停效果 */
        .level-selector:hover {
            left: 0;
        }
        
        /* 选择器内部元素样式 */
        .level-selector select {
            width: 180px; /* 增加宽度确保"卡"字显示完整 */
            padding: 10px;
            padding-right: 25px; /* 减少右边距，避免箭头太靠右 */
            margin-left: -10px; /* 向左移动10px */
            background: rgba(50, 50, 55, 0.8);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            outline: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='rgba(255, 255, 255, 0.5)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center; /* 调整箭头位置 */
            background-size: 12px; /* 调整箭头大小 */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .level-selector label {
            display: block;
            margin-bottom: 10px;
            color: rgba(235, 165, 16, 0.911);
            font-size: 18px;
            font-weight: 500;
        }
        
        /* 调试模式样式 */
        .debug-mode .debug-info {
            display: block !important;
            margin-top: 15px;
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.5);
            border-left: 3px solid #30d158;
            border-radius: 8px;
        }
        
        .debug-info {
            display: none; /* 默认隐藏 */
        }
        
        .debug-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 9999;
        }
        
        .debug-button {
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(45, 45, 50, 0.8);
            color: #30d158;
            border: 1px solid #30d158;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .debug-button:hover {
            background: rgba(45, 45, 50, 1);
        }
        
        .raw-data-display {
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 0.9rem;
            color: #fff;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid rgba(255, 159, 10, 0.5);
        }
        
        /* 添加未找到解析的样式 */
        .missing-explanation {
            background-color: rgba(45, 45, 50, 0.3);
            border-left: 3px solid rgba(200, 200, 200, 0.3);
            font-style: italic;
        }
        
        /* 确保长文本内容自动换行 */
        .question-title, .your-answer, .correct-answer, .explanation, .option-item {
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }
        
        /* 调整选项容器宽度 */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 6px; /* 从8px减少到6px使选项间距更紧凑 */
            margin: 12px 0; /* 从16px减少到12px */
            padding: 8px;
            background: rgba(45, 45, 50, 0.4);
            border-radius: 8px;
            width: 100%;
            max-width: 100%;
        }
        
        /* 防止溢出和滚动条 */
        .background-effects, .level-header, .debug-info, .level-selector, header {
            max-width: 100%;
            overflow-x: hidden;
        }
        
        /* 恢复滚动条设置 */
        html, body, .container, .wrong-answers-container {
            overflow-y: auto; /* 恢复垂直滚动 */
        }
        
        .wrong-answers-content {
            overflow-y: auto; /* 确保内容区可以垂直滚动 */
        }
        
        /* 修改关卡标题样式 */
        .level-header h2, .level-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            background: linear-gradient(to right, #FF9F0A, #FF375F); /* 使用渐变色 */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none; /* 移除文字阴影 */
        }
        
        /* 找到并移除"所有关卡错题汇总"的相关样式和HTML */
        .level-summary-title {
            display: none; /* 隐藏所有关卡错题汇总标题 */
        }

        /* 全局禁用所有滚动条 */
        *::-webkit-scrollbar {
            width: 0 !important;
            height: 0 !important;
            background: transparent !important;
            display: none !important;
        }

        * {
            scrollbar-width: none !important; /* Firefox */
            -ms-overflow-style: none !important; /* IE and Edge */
        }

        /* 保持内容区域的滚动功能 */
        .wrong-answers-content {
            overflow-y: auto !important; /* 只在内容区域保留垂直滚动条 */
            overflow-x: hidden !important; /* 防止水平滚动条 */
            scrollbar-width: thin !important; /* Firefox */
            -ms-overflow-style: auto !important; /* IE and Edge */
        }

        /* 自定义内容区域滚动条样式 */
        .wrong-answers-content::-webkit-scrollbar {
            width: 8px !important;
            display: block !important;
        }

        .wrong-answers-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1) !important;
            border-radius: 4px !important;
        }

        .wrong-answers-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2) !important;
            border-radius: 4px !important;
        }

        .wrong-answers-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3) !important;
        }

        /* 内容包装器 */
        .content-wrapper {
            position: relative;
            z-index: 1;
            width: 100%; /* 确保宽度不超过父容器 */
        }
        
        /* 关卡标题样式 */
        .level-header {
            background: rgba(35, 35, 40, 0.95);
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 4px solid #FF9F0A;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }
        
        /* 粘性标题样式 */
        .sticky-header {
            position: sticky;
            top: 0;
            background: rgba(35, 35, 40, 0.95);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 100;
            padding: 0 15px; /* 水平内边距 */
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 4px solid #FF9F0A;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            display: flex; /* 使用弹性布局来实现垂直居中 */
            align-items: center-30; /* 垂直居中 */
            justify-content: flex-start; /* 水平左对齐 */
            height: 50px; /* 适当的容器高度 */
        }
        
        /* 活跃的标题样式 */
        .active-header {
            background: rgba(45, 45, 50, 0.98);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            border-left: 4px solid #FF375F;
        }
        
        .level-title {
            margin: 0;
            padding: 0; /* 无内边距 */
            font-size: 1.2rem;
            color: #fff;
            background: linear-gradient(135deg, #FF9F0A, #FF375F);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transform: translateY(var(--title-vertical-offset)); /* 使用变量控制垂直位置 */
        }
        
        .wrong-answer-card {
            background: rgba(45, 45, 50, 0.5);
            border-radius: 18px;
            padding: 15px; /* 从20px减少到15px使内容更紧凑 */
            margin-bottom: 20px; /* 从25px减少到20px使卡片间距更紧凑 */
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            overflow: hidden;
            word-wrap: break-word; /* 确保长文本会自动换行 */
            width: 100%; /* 确保宽度不超过父容器 */
        }
    </style>
</head>
<body>
    <!-- 添加背景光斑效果 -->
    <div class="background-effects">
        <div class="light-spot"></div>
        <div class="light-spot"></div>
        <div class="light-spot"></div>
        <div class="light-spot"></div>
    </div>
    
    <div class="container">
        <a href="index.html" class="back-button">返回首页</a>
        
        <!-- 关卡选择器 - 移至左侧固定位置 -->
        <div class="level-selector">
            <label for="level-select">选择错题关卡</label>
            <select id="level-select">
                <option value="all">默认显示所有关卡</option>
                <!-- 动态生成的关卡选项 -->
            </select>
            <!-- 添加黄色标签和金属条纹 -->
            <div class="yellow-tab">
                <div class="metal-stripe metal-stripe-1"></div>
                <div class="metal-stripe metal-stripe-2"></div>
                <div class="metal-stripe metal-stripe-3"></div>
                <div class="metal-stripe metal-stripe-4"></div>
            </div>
        </div>
        
        <header>
            <h1>Python答题挑战 - 错题集<div class="title-glow"></div></h1>
        </header>
        
        <div class="wrong-answers-container">
            <div class="content-wrapper">
                <div id="wrongAnswersContent" class="wrong-answers-content">
                    <!-- 错题将通过JavaScript动态加载 -->
                </div>
            </div>
        </div>
    </div>

<script>
    // 全局变量
    let currentLevel = 1;
    let source = 'home';
    let debugMode = false; // 调试模式标志

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 检查URL参数，获取关卡ID和来源
        const urlParams = new URLSearchParams(window.location.search);
        
        currentLevel = parseInt(urlParams.get('level')) || null;
        source = urlParams.get('source') || 'quiz';
        
        // 调试模式
        if (urlParams.get('debug') === 'true') {
            document.body.classList.add('debug-mode');
            addDebugControls();
        }
        
        // 先加载配置文件
        loadLevelsConfig().then(() => {
            console.log("关卡配置加载完成，开始加载错题...");
            
            // 再加载错题数据
            loadWrongQuestions();
            
            // 显示当前关卡信息
            if (currentLevel) {
                document.getElementById('current-level').textContent = currentLevel;
                const levelHeader = document.getElementById('level-header');
                if (levelHeader) {
                    levelHeader.innerHTML = `<h2>第${currentLevel}关 - ${getLevelTitle(currentLevel)}</h2>`;
                }
            }
        }).catch(error => {
            console.error("配置加载失败:", error);
            
            // 即使配置加载失败，仍然加载错题
            loadWrongQuestions();
        });
        
        // 初始化返回按钮
        const backButton = document.getElementById('back-button');
        if (backButton) {
            backButton.addEventListener('click', function() {
                if (source === 'quiz') {
                    // 从答题页来，返回到答题页
                    window.location.href = currentLevel ? `quiz.html?level=${currentLevel}` : 'index.html';
                } else {
                    // 从首页来，返回首页
                    window.location.href = 'index.html';
                }
            });
        }
    });
    
    // 根据来源设置UI
    function setupUIBasedOnSource() {
        const backButton = document.querySelector('.back-button');
        const levelSelector = document.querySelector('.level-selector');
        const levelSubtitle = document.getElementById('level-subtitle');
    
        // 隐藏任何关卡子标题，因为这是错题集页面
        if (levelSubtitle) levelSubtitle.style.display = 'none';
        
        // 显示关卡选择器，默认选择"所有关卡"
        if (levelSelector) {
            const levelSelect = document.getElementById('level-select');
            if (levelSelect) levelSelect.value = 'all';
        }
        
        if (source === 'home') {
            // 从首页进入时
            if (backButton) {
                backButton.href = 'index.html';
                backButton.textContent = '返回首页';
            }
        } else if (source === 'summary') {
            // 从总结页进入时
            if (backButton) {
                backButton.href = `quiz.html?level=${currentLevel}&showSummary=true`;
                backButton.textContent = '返回答题总结';
            }
        } else {
            // 默认情况
            if (backButton) backButton.href = 'index.html';
        }
    }
    
    // 题库数据
    const questionBank = {
        1: [
            {
                question: "以下哪个不是Python的主要特点？",
                options: [
                    "简单易学，语法清晰",
                    "跨平台性强，可移植性好",
                    "编译执行，运行速度快",
                    "面向对象，支持函数式编程"
                ],
                correctAnswer: 2,
                explanation: "Python是<strong>解释型语言</strong>，不是编译执行的。Python代码在运行时由解释器逐行解释执行，这使得它的执行速度相对较慢，但带来了更好的跨平台性和开发效率。其他选项都是Python的特点：简单易学、跨平台性强、支持面向对象和函数式编程。"
            },
            {
                question: "Python是什么类型的编程语言？",
                options: [
                    "编译型语言",
                    "解释型语言",
                    "汇编语言",
                    "机器语言"
                ],
                correctAnswer: 1,
                explanation: "Python是一种<strong>解释型语言</strong>。这意味着Python代码在运行时由解释器直接执行，不需要预先编译成机器码。这种特性使得Python具有良好的可移植性，同样的代码可以在不同的平台上运行，但执行速度相对较慢。"
            },
            {
                question: "Python中的缩进规则要求必须使用4个空格进行缩进。",
                type: "true_false",
                correctAnswer: false,
                explanation: "这个说法是错误的。虽然PEP 8规范建议使用4个空格进行缩进，但这不是强制要求。Python中最重要的缩进规则是保持一致性，即在同一个代码块中使用相同的缩进方式。你可以使用任意数量的空格或Tab，只要在整个代码块中保持一致即可。"
            },
            {
                question: "Python中的注释符号是什么？",
                options: [
                    "//",
                    "#",
                    "/* */",
                    "--"
                ],
                correctAnswer: 1,
                explanation: "在Python中，单行注释使用<strong>#符号</strong>。多行注释可以使用三个单引号或三个双引号。其他选项是其他编程语言的注释符号：// 用于C++/Java，/* */ 用于C/Java的多行注释，-- 用于SQL。"
            },
            {
                question: "Python中如何定义多行字符串？",
                options: [
                    "使用单引号包裹",
                    "使用双引号包裹",
                    "使用三个单引号或三个双引号包裹",
                    "使用反斜杠换行"
                ],
                correctAnswer: 2,
                explanation: "在Python中，<strong>三个单引号或三个双引号</strong>可以用来定义多行字符串。这种方式可以保留字符串中的换行和空格，使得多行文本的编写更加方便。单引号和双引号只能定义单行字符串，使用反斜杠换行会被解释为连续的单行。"
            },
            {
                question: "在Python中，变量名必须以字母或____开头。",
                type: "fill_blank",
                correctAnswer: "_",
                explanation: "在Python中，变量名必须以字母或下划线（_）开头，不能以数字开头。变量名可以包含字母、数字和下划线，但第一个字符必须是字母或下划线。这是Python的命名规则之一，用于确保变量名的有效性和可读性。"
            },
            {
                question: "Python中的标识符区分大小写。",
                type: "true_false",
                correctAnswer: true,
                explanation: "Python中的标识符（如变量名、函数名等）是区分大小写的。例如，'name'和'Name'是两个不同的标识符。这种设计使得Python的命名更加灵活，但也要求程序员在命名时保持一致性。"
            },
            {
                question: "Python中如何表示一个空列表？",
                options: [
                    "[]",
                    "()",
                    "{}",
                    "None"
                ],
                correctAnswer: 0,
                explanation: "在Python中，空列表使用<strong>[]</strong>表示。()表示空元组，{}表示空字典，None表示空值。列表是Python中最常用的数据结构之一，可以存储任意类型的元素。"
            },
            {
                question: "Python中的None表示什么？",
                options: [
                    "空字符串",
                    "空列表",
                    "空值或空对象",
                    "0"
                ],
                correctAnswer: 2,
                explanation: "在Python中，<strong>None</strong>是一个特殊的常量，表示空值或空对象。它不同于空字符串、空列表或数字0。None通常用于表示函数没有返回值或变量没有赋值的情况。"
            },
            {
                question: "Python中的布尔值True和False的首字母必须大写。",
                type: "true_false",
                correctAnswer: true,
                explanation: "在Python中，布尔值True和False的首字母必须大写。这是Python的语法要求，小写的true和false不是有效的布尔值。这种设计使得布尔值在代码中更加醒目和易于识别。"
            },
            {
                question: "Python中如何表示一个空字典？",
                options: [
                    "[]",
                    "()",
                    "{}",
                    "None"
                ],
                correctAnswer: 2,
                explanation: "在Python中，空字典使用<strong>{}</strong>表示。[]表示空列表，()表示空元组，None表示空值。字典是Python中的一种映射类型，用于存储键值对。"
            },
            {
                question: "Python中的字符串是不可变的。",
                type: "true_false",
                correctAnswer: true,
                explanation: "在Python中，字符串是不可变的（immutable）数据类型。这意味着一旦创建了一个字符串，就不能修改它的内容。如果需要修改字符串，必须创建一个新的字符串。这种设计使得字符串操作更加安全和可预测。"
            },
            {
                question: "Python中如何表示一个空元组？",
                options: [
                    "[]",
                    "()",
                    "{}",
                    "None"
                ],
                correctAnswer: 1,
                explanation: "在Python中，空元组使用<strong>()</strong>表示。[]表示空列表，{}表示空字典，None表示空值。元组是不可变的序列类型，一旦创建就不能修改。"
            },
            {
                question: "Python中的变量必须先声明类型。",
                type: "true_false",
                correctAnswer: false,
                explanation: "这个说法是错误的。Python是一种动态类型语言，变量不需要预先声明类型。变量的类型是在赋值时自动确定的，并且可以在程序运行过程中改变。这种特性使得Python编程更加灵活和简洁。"
            },
            {
                question: "Python中如何表示一个空集合？",
                options: [
                    "[]",
                    "()",
                    "{}",
                    "set()"
                ],
                correctAnswer: 3,
                explanation: "在Python中，空集合使用<strong>set()</strong>表示。{}表示空字典，[]表示空列表，()表示空元组。集合是一种无序且不重复的元素集合。"
            },
            {
                question: "Python中的变量名可以包含空格。",
                type: "true_false",
                correctAnswer: false,
                explanation: "这个说法是错误的。Python中的变量名不能包含空格。变量名只能包含字母、数字和下划线，并且必须以字母或下划线开头。如果需要表示多个单词，可以使用下划线连接，如'my_variable'。"
            },
            {
                question: "Python中的数字类型包括哪些？",
                options: [
                    "整数、浮点数、复数",
                    "整数、浮点数、字符串",
                    "整数、浮点数、布尔值",
                    "整数、浮点数、列表"
                ],
                correctAnswer: 0,
                explanation: "Python中的数字类型包括<strong>整数（int）、浮点数（float）和复数（complex）</strong>。整数是没有小数部分的数字，浮点数包含小数部分，复数包含实部和虚部。"
            },
            {
                question: "Python中的字符串可以使用单引号或双引号定义。",
                type: "true_false",
                correctAnswer: true,
                explanation: "在Python中，字符串可以使用单引号或双引号定义，两种方式是完全等价的。这种设计使得在字符串中包含引号时更加方便，可以选择使用不同类型的引号来避免转义字符。"
            },
            {
                question: "Python中的变量名可以以数字开头。",
                type: "true_false",
                correctAnswer: false,
                explanation: "这个说法是错误的。Python中的变量名不能以数字开头。变量名必须以字母或下划线开头，后面可以包含字母、数字和下划线。这种规则确保了变量名的可读性和有效性。"
            }
        ]
    };
    
    // 初始化关卡选择器
    function initLevelSelector() {
        const levelSelect = document.getElementById('level-select');
        if (!levelSelect) return;
        
        // 获取关卡标题元素
        const levelSubtitle = document.getElementById('level-subtitle');
        
        // 添加调试信息容器
        const debugInfo = document.createElement('div');
        debugInfo.className = 'debug-info';
        document.getElementById('wrongAnswersContent').innerHTML = '';
        document.getElementById('wrongAnswersContent').appendChild(debugInfo);
        
        debugInfo.innerHTML = `正在初始化关卡选择器...<br>
            - 正在从 localStorage 加载错题数据...`;
        
        try {
            // 正确获取错题数据
            const wrongQuestionsData = JSON.parse(localStorage.getItem('wrong-questions-data')) || { wrongQuestions: {} };
            
            // 获取包含错题的所有关卡
            const levelsWithWrongAnswers = Object.keys(wrongQuestionsData.wrongQuestions)
                .filter(level => {
                    const wrongAnswers = wrongQuestionsData.wrongQuestions[level] || [];
                    return wrongAnswers.length > 0;
                })
                .map(level => parseInt(level))
                .sort((a, b) => a - b);
            
            debugInfo.innerHTML = `关卡选择器初始化：<br>
                - 包含错题的关卡数：${levelsWithWrongAnswers.length}<br>
                - 关卡列表：[${levelsWithWrongAnswers.join(', ')}]<br>
                - 最后更新时间：${wrongQuestionsData.lastUpdated || '未知'}`;
            
            // 清空现有选项
            while (levelSelect.firstChild) {
                levelSelect.removeChild(levelSelect.firstChild);
            }
            
            // 添加"所有关卡"选项
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = '默认显示所有关卡';
            levelSelect.appendChild(allOption);
            
            // 填充关卡选择器
            levelsWithWrongAnswers.forEach(level => {
                const option = document.createElement('option');
                option.value = level;
                option.textContent = `第${level}关 - ${getLevelTitle(level)}`;
                levelSelect.appendChild(option);
            });
            
            // 设置初始选中值
            if (source === 'home') {
                levelSelect.value = 'all';
            } else {
                // 检查当前关卡是否有错题
                if (levelsWithWrongAnswers.includes(currentLevel)) {
                    levelSelect.value = currentLevel;
                } else {
                    levelSelect.value = 'all';
                }
            }
            
            // 添加选择事件
            levelSelect.addEventListener('change', function() {
                const selectedLevel = this.value;
                
                if (selectedLevel === 'all') {
                    // 显示所有关卡错题
                    if (levelSubtitle) levelSubtitle.style.display = 'none';
                    displayAllWrongAnswers();
                } else {
                    // 显示特定关卡错题，始终隐藏关卡标题
                    const level = parseInt(selectedLevel);
                    const currentLevelElem = document.getElementById('current-level');
                    if (currentLevelElem) currentLevelElem.textContent = level;
                    // 无论选择哪个关卡，都隐藏小标题
                    if (levelSubtitle) levelSubtitle.style.display = 'none';
                    displayWrongAnswersByLevel(level);
                }
            });
            
            // 触发初始显示
            levelSelect.dispatchEvent(new Event('change'));
            
        } catch (error) {
            console.error('初始化关卡选择器失败:', error);
            debugInfo.innerHTML = `<strong style="color: #ff375f">初始化关卡选择器失败：${error.message}</strong>`;
        }
    }
    
    // 添加调试控制按钮
    function addDebugControls() {
        const controlsContainer = document.createElement('div');
        controlsContainer.className = 'debug-controls';
        
        // 显示原始数据按钮
        const showRawDataBtn = document.createElement('button');
        showRawDataBtn.className = 'debug-button';
        showRawDataBtn.textContent = '查看错题原始数据';
        showRawDataBtn.addEventListener('click', function() {
            showRawWrongAnswersData();
        });
        
        // 显示题库数据按钮
        const showQuestionBankBtn = document.createElement('button');
        showQuestionBankBtn.className = 'debug-button';
        showQuestionBankBtn.textContent = '查看题库数据';
        showQuestionBankBtn.addEventListener('click', function() {
            showQuestionBankData();
        });
        
        // 显示本地存储按钮
        const showLocalStorageBtn = document.createElement('button');
        showLocalStorageBtn.className = 'debug-button';
        showLocalStorageBtn.textContent = '查看所有本地存储';
        showLocalStorageBtn.addEventListener('click', function() {
            showAllLocalStorage();
        });
        
        // 切换调试信息显示按钮
        const toggleDebugInfoBtn = document.createElement('button');
        toggleDebugInfoBtn.className = 'debug-button';
        toggleDebugInfoBtn.textContent = '切换调试信息显示';
        toggleDebugInfoBtn.addEventListener('click', function() {
            document.body.classList.toggle('debug-mode');
        });
        
        // 添加按钮到容器
        controlsContainer.appendChild(showRawDataBtn);
        controlsContainer.appendChild(showQuestionBankBtn);
        controlsContainer.appendChild(showLocalStorageBtn);
        controlsContainer.appendChild(toggleDebugInfoBtn);
        
        // 添加容器到文档
        document.body.appendChild(controlsContainer);
    }
    
    // 显示错题原始数据
    function showRawWrongAnswersData() {
        try {
            const wrongQuestionsData = JSON.parse(localStorage.getItem('wrong-questions-data')) || { wrongQuestions: {} };
            
            // 显示一个模态对话框
            const modalContainer = document.createElement('div');
            modalContainer.style.position = 'fixed';
            modalContainer.style.top = '0';
            modalContainer.style.left = '0';
            modalContainer.style.width = '100%';
            modalContainer.style.height = '100%';
            modalContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
            modalContainer.style.display = 'flex';
            modalContainer.style.justifyContent = 'center';
            modalContainer.style.alignItems = 'center';
            modalContainer.style.zIndex = '10000';
            
            const modalContent = document.createElement('div');
            modalContent.style.width = '80%';
            modalContent.style.maxWidth = '800px';
            modalContent.style.maxHeight = '80%';
            modalContent.style.backgroundColor = 'rgba(45, 45, 50, 0.9)';
            modalContent.style.borderRadius = '12px';
            modalContent.style.padding = '20px';
            modalContent.style.boxShadow = '0 5px 30px rgba(0, 0, 0, 0.5)';
            modalContent.style.overflow = 'auto';
            
            // 标题
            const title = document.createElement('h3');
            title.textContent = '错题原始数据';
            title.style.marginBottom = '15px';
            title.style.color = '#fff';
            modalContent.appendChild(title);
            
            // 关闭按钮
            const closeButton = document.createElement('button');
            closeButton.textContent = '关闭';
            closeButton.className = 'debug-button';
            closeButton.style.position = 'absolute';
            closeButton.style.top = '20px';
            closeButton.style.right = '20px';
            closeButton.addEventListener('click', function() {
                document.body.removeChild(modalContainer);
            });
            modalContent.appendChild(closeButton);
            
            // 数据显示
            const dataDisplay = document.createElement('div');
            dataDisplay.className = 'raw-data-display';
            dataDisplay.textContent = JSON.stringify(wrongQuestionsData, null, 2);
            modalContent.appendChild(dataDisplay);
            
            modalContainer.appendChild(modalContent);
            document.body.appendChild(modalContainer);
            
        } catch (error) {
            alert('无法读取错题数据: ' + error.message);
        }
    }
    
    // 显示题库数据
    function showQuestionBankData() {
        // 显示一个模态对话框
        const modalContainer = document.createElement('div');
        modalContainer.style.position = 'fixed';
        modalContainer.style.top = '0';
        modalContainer.style.left = '0';
        modalContainer.style.width = '100%';
        modalContainer.style.height = '100%';
        modalContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
        modalContainer.style.display = 'flex';
        modalContainer.style.justifyContent = 'center';
        modalContainer.style.alignItems = 'center';
        modalContainer.style.zIndex = '10000';
        
        const modalContent = document.createElement('div');
        modalContent.style.width = '80%';
        modalContent.style.maxWidth = '800px';
        modalContent.style.maxHeight = '80%';
        modalContent.style.backgroundColor = 'rgba(45, 45, 50, 0.9)';
        modalContent.style.borderRadius = '12px';
        modalContent.style.padding = '20px';
        modalContent.style.boxShadow = '0 5px 30px rgba(0, 0, 0, 0.5)';
        modalContent.style.overflow = 'auto';
        
        // 标题
        const title = document.createElement('h3');
        title.textContent = '题库数据';
        title.style.marginBottom = '15px';
        title.style.color = '#fff';
        modalContent.appendChild(title);
        
        // 关闭按钮
        const closeButton = document.createElement('button');
        closeButton.textContent = '关闭';
        closeButton.className = 'debug-button';
        closeButton.style.position = 'absolute';
        closeButton.style.top = '20px';
        closeButton.style.right = '20px';
        closeButton.addEventListener('click', function() {
            document.body.removeChild(modalContainer);
        });
        modalContent.appendChild(closeButton);
        
        // 数据显示
        const dataDisplay = document.createElement('div');
        dataDisplay.className = 'raw-data-display';
        
        // 获取每个关卡的题目数量信息
        const questionCountInfo = {};
        for (const level in questionBank) {
            questionCountInfo[`第${level}关`] = {
                题目数量: questionBank[level].length,
                题目类型: {}
            };
            
            // 统计不同类型的题目
            questionBank[level].forEach(question => {
                const type = question.type || 'multiple_choice';
                if (!questionCountInfo[`第${level}关`].题目类型[type]) {
                    questionCountInfo[`第${level}关`].题目类型[type] = 0;
                }
                questionCountInfo[`第${level}关`].题目类型[type]++;
            });
        }
        
        dataDisplay.textContent = JSON.stringify(questionCountInfo, null, 2);
        
        // 添加关卡选择器
        const levelSelect = document.createElement('select');
        levelSelect.style.padding = '8px';
        levelSelect.style.margin = '10px 0';
        levelSelect.style.borderRadius = '8px';
        levelSelect.style.backgroundColor = 'rgba(30, 30, 35, 0.8)';
        levelSelect.style.color = '#fff';
        
        // 添加"概览"选项
        const summaryOption = document.createElement('option');
        summaryOption.value = 'summary';
        summaryOption.textContent = '题库概览';
        levelSelect.appendChild(summaryOption);
        
        // 添加每个关卡的选项
        for (const level in questionBank) {
            const option = document.createElement('option');
            option.value = level;
            option.textContent = `第${level}关 (${questionBank[level].length}题)`;
            levelSelect.appendChild(option);
        }
        
        // 监听选择事件
        levelSelect.addEventListener('change', function() {
            const selectedValue = this.value;
            
            if (selectedValue === 'summary') {
                dataDisplay.textContent = JSON.stringify(questionCountInfo, null, 2);
            } else {
                const selectedLevel = parseInt(selectedValue);
                dataDisplay.textContent = JSON.stringify(questionBank[selectedLevel], null, 2);
            }
        });
        
        modalContent.insertBefore(levelSelect, dataDisplay);
        modalContent.appendChild(dataDisplay);
        
        modalContainer.appendChild(modalContent);
        document.body.appendChild(modalContainer);
    }
    
    // 显示所有本地存储
    function showAllLocalStorage() {
        // 创建模态对话框
        const modalContainer = document.createElement('div');
        modalContainer.style.position = 'fixed';
        modalContainer.style.top = '0';
        modalContainer.style.left = '0';
        modalContainer.style.width = '100%';
        modalContainer.style.height = '100%';
        modalContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
        modalContainer.style.display = 'flex';
        modalContainer.style.justifyContent = 'center';
        modalContainer.style.alignItems = 'center';
        modalContainer.style.zIndex = '10000';
        
        const modalContent = document.createElement('div');
        modalContent.style.width = '80%';
        modalContent.style.maxWidth = '800px';
        modalContent.style.maxHeight = '80%';
        modalContent.style.backgroundColor = 'rgba(45, 45, 50, 0.9)';
        modalContent.style.borderRadius = '12px';
        modalContent.style.padding = '20px';
        modalContent.style.boxShadow = '0 5px 30px rgba(0, 0, 0, 0.5)';
        modalContent.style.overflow = 'auto';
        
        // 标题
        const title = document.createElement('h3');
        title.textContent = '本地存储数据';
        title.style.marginBottom = '15px';
        title.style.color = '#fff';
        modalContent.appendChild(title);
        
        // 关闭按钮
        const closeButton = document.createElement('button');
        closeButton.textContent = '关闭';
        closeButton.className = 'debug-button';
        closeButton.style.position = 'absolute';
        closeButton.style.top = '20px';
        closeButton.style.right = '20px';
        closeButton.addEventListener('click', function() {
            document.body.removeChild(modalContainer);
        });
        modalContent.appendChild(closeButton);
        
        // 获取所有localStorage内容
        const localStorageData = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            try {
                const value = localStorage.getItem(key);
                
                // 尝试解析JSON
                try {
                    localStorageData[key] = JSON.parse(value);
                } catch (e) {
                    // 如果不是JSON，则存储原始字符串
                    localStorageData[key] = value;
                }
            } catch (error) {
                localStorageData[key] = `[无法读取: ${error.message}]`;
            }
        }
        
        // 数据显示
        const dataDisplay = document.createElement('div');
        dataDisplay.className = 'raw-data-display';
        dataDisplay.textContent = JSON.stringify(localStorageData, null, 2);
        modalContent.appendChild(dataDisplay);
        
        modalContainer.appendChild(modalContent);
        document.body.appendChild(modalContainer);
    }
    
    // 处理和显示特定关卡的错题
    function displayWrongAnswersByLevel(level) {
        const wrongAnswersContent = document.getElementById('wrongAnswersContent');
        wrongAnswersContent.innerHTML = '';
        
        // 添加调试信息容器
        const debugInfo = document.createElement('div');
        debugInfo.className = 'debug-info';
        wrongAnswersContent.appendChild(debugInfo);
        
        debugInfo.innerHTML = `开始加载错题...<br>
            - 当前关卡：${level}<br>
            - 正在从 localStorage 加载...`;
        
        // 从localStorage加载错题数据
        try {
            const wrongQuestionsData = JSON.parse(localStorage.getItem('wrong-questions-data')) || { wrongQuestions: {} };
            const wrongAnswers = wrongQuestionsData.wrongQuestions[level] || [];
            
            // 获取完整的题库数据，如果本地题库不完整，可以对题库进行复制和扩展
            let levelQuestions = questionBank[level] || [];
            
            // 确保题库数据存在
            if (!questionBank[level] || levelQuestions.length === 0) {
                console.warn(`关卡 ${level} 的题库数据不存在或为空，尝试从错题中恢复题目数据`);
                
                // 尝试从错题记录中重建部分题库
                wrongAnswers.forEach(item => {
                    if (item.questionKey && !levelQuestions.some(q => q.question === item.questionKey)) {
                        // 创建一个基本题目结构
                        const recoveredQuestion = {
                            question: item.questionKey,
                            type: item.questionType || 'multiple_choice', // 默认为选择题
                            correctAnswer: item.correctAnswer,
                            options: item.options || ['选项内容缺失'],
                            explanation: item.explanation || '该题暂无解析说明'
                        };
                        levelQuestions.push(recoveredQuestion);
                    }
                });
                
                // 如果还是没有题目，显示错误信息并返回
                if (levelQuestions.length === 0) {
                    debugInfo.innerHTML = `<strong style="color: #ff375f">错误：无法加载关卡${level}的题库数据</strong>`;
                    
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'error-message';
                    errorMessage.textContent = `无法显示错题，题库数据缺失。请尝试重新打开页面或联系开发者。`;
                    wrongAnswersContent.appendChild(errorMessage);
                    return;
                }
            }
            
            // 更新调试信息
            debugInfo.innerHTML = `数据加载成功：<br>
                - 当前关卡：${level}<br>
                - 错题总数：${wrongAnswers.length}<br>
                - 题库中该关卡题目数：${levelQuestions.length}<br>
                - 最后更新时间：${wrongQuestionsData.lastUpdated || '未知'}<br>
                - 数据来源：localStorage`;
            
            // 首先添加粘性标题 - 即使是单一关卡也添加
            const levelHeaderElem = document.createElement('div');
            levelHeaderElem.id = `level-${level}-header`;
            levelHeaderElem.className = 'level-header sticky-header active-header'; // 添加active-header类表示当前活跃的标题
            levelHeaderElem.innerHTML = `<h2 class="level-title">第${level}关 - ${getLevelTitle(level)}</h2>`;
            levelHeaderElem.dataset.level = level;
            wrongAnswersContent.appendChild(levelHeaderElem);
        
            // 如果没有错题，显示提示
            if (wrongAnswers.length === 0) {
                const noWrongAnswers = document.createElement('div');
                noWrongAnswers.className = 'no-wrong-answers';
                noWrongAnswers.textContent = `太棒了！第${level}关你没有错题！`;
                wrongAnswersContent.appendChild(noWrongAnswers);
                return;
            }
        
            // 显示错题
            let displayedCount = 0;
            wrongAnswers.forEach((item, index) => {
                // 通过多种方式尝试找到题目
                let question = null;
                
                // 1. 通过索引查找
                if (typeof item.questionIndex === 'number' && levelQuestions[item.questionIndex]) {
                    question = levelQuestions[item.questionIndex];
                } 
                // 2. 通过问题文本查找
                else if (item.questionKey) {
                    question = levelQuestions.find(q => q.question === item.questionKey);
                    if (!question) {
                        // 尝试模糊匹配 - 允许部分文本匹配
                        question = levelQuestions.find(q => 
                            q.question && item.questionKey && 
                            (q.question.includes(item.questionKey) || 
                             item.questionKey.includes(q.question))
                        );
                    }
                }
                
                // 3. 如果还是找不到，创建一个完整的临时题目对象
                if (!question) {
                    console.warn(`无法在题库中找到对应题目，创建临时题目数据`, item);
                    
                    let tempOptions = [];
                    // 尝试从用户答案中恢复选项
                    if (item.options && Array.isArray(item.options)) {
                        tempOptions = item.options;
                    } else if (typeof item.userAnswer === 'number' && item.questionType !== 'true_false') {
                        // 为选择题创建至少足够包含用户答案的选项数组
                        tempOptions = Array(Math.max(4, item.userAnswer + 1)).fill('选项内容缺失');
                        // 如果知道正确答案，确保也能包含
                        if (typeof item.correctAnswer === 'number') {
                            tempOptions = Array(Math.max(tempOptions.length, item.correctAnswer + 1)).fill('选项内容缺失');
                        }
                    }
                    
                    question = {
                        question: item.questionKey || `题目 #${index + 1}`,
                        type: item.questionType || 
                              (typeof item.userAnswer === 'boolean' ? 'true_false' : 
                               typeof item.userAnswer === 'number' ? 'multiple_choice' : 'fill_blank'),
                        options: tempOptions,
                        correctAnswer: item.correctAnswer !== undefined ? item.correctAnswer : '数据缺失',
                        explanation: item.explanation || '该题暂无解析说明'
                    };
                }
                
                const wrongAnswerItem = createWrongAnswerItem(question, item.userAnswer, level, index);
                wrongAnswersContent.appendChild(wrongAnswerItem);
                displayedCount++;
            });
            
            // 更新统计信息
            debugInfo.innerHTML += `<br>成功显示错题数：${displayedCount}/${wrongAnswers.length}`;
            
            // 如果没有成功显示任何错题，显示错误信息
            if (displayedCount === 0 && wrongAnswers.length > 0) {
                const errorMessage = document.createElement('div');
                errorMessage.className = 'error-message';
                errorMessage.textContent = `虽然存在${wrongAnswers.length}个错题记录，但无法显示。可能是题库数据与错题记录不匹配。`;
                wrongAnswersContent.appendChild(errorMessage);
            }
            
        } catch (error) {
            console.error('加载错题失败:', error);
            debugInfo.innerHTML = `<strong style="color: #ff375f">错误信息：${error.message}</strong>`;
            
            // 显示用户友好的错误信息
            const errorMessage = document.createElement('div');
            errorMessage.className = 'error-message';
            errorMessage.innerHTML = `
                <p>加载错题时遇到问题。</p>
                <p>错误：${error.message}</p>
                <p>请尝试刷新页面，或检查浏览器控制台获取更多信息。</p>
            `;
            wrongAnswersContent.appendChild(errorMessage);
        }
    }
    
    // 显示所有关卡的错题
    function displayAllWrongAnswers() {
        const wrongAnswersContentElem = document.getElementById('wrongAnswersContent');
        if (!wrongAnswersContentElem) return;
        
        wrongAnswersContentElem.innerHTML = ''; // 清空现有内容
        
        try {
            const wrongQuestionsData = JSON.parse(localStorage.getItem('wrong-questions-data')) || { wrongQuestions: {} };
            const allLevelsWithWrongAnswers = Object.keys(wrongQuestionsData.wrongQuestions);
            
            // 计算错题总数
            let totalWrongQuestions = 0;
            allLevelsWithWrongAnswers.forEach(level => {
                const wrongAnswers = wrongQuestionsData.wrongQuestions[level] || [];
                totalWrongQuestions += wrongAnswers.length;
            });
            
            // 创建调试信息
            const debugInfo = document.createElement('div');
            debugInfo.className = 'debug-info';
            debugInfo.innerHTML = `显示所有关卡错题：<br>
                - 包含错题的关卡数：${allLevelsWithWrongAnswers.length}<br>
                - 错题总数：${totalWrongQuestions}<br>
                - 最后更新时间：${wrongQuestionsData.lastUpdated || '未知'}`;
            wrongAnswersContentElem.appendChild(debugInfo);
            
            // 不再创建"所有关卡错题汇总"标题，完全移除
            
            // 如果没有错题，显示提示信息
            if (totalWrongQuestions === 0) {
                const noWrongAnswersMsg = document.createElement('div');
                noWrongAnswersMsg.className = 'empty-state';
                noWrongAnswersMsg.innerHTML = `
                    <div class="empty-icon">🎉</div>
                    <h3>太棒了！</h3>
                    <p>你目前没有任何错题记录。</p>
                    <p>继续保持良好的学习状态！</p>
                `;
                wrongAnswersContentElem.appendChild(noWrongAnswersMsg);
                return;
            }
            
            // 按关卡顺序显示错题
            const sortedLevels = allLevelsWithWrongAnswers
                .map(level => parseInt(level))
                .sort((a, b) => a - b);
            
            sortedLevels.forEach(level => {
                const wrongAnswers = wrongQuestionsData.wrongQuestions[level] || [];
                
                if (wrongAnswers.length > 0) {
                    // 创建关卡标题
                    const levelHeaderElem = document.createElement('div');
                    levelHeaderElem.id = `level-${level}-header`;
                    levelHeaderElem.className = 'level-header sticky-header'; // 添加sticky-header类
                    levelHeaderElem.innerHTML = `<h2 class="level-title">第${level}关 - ${getLevelTitle(level)}</h2>`;
                    
                    // 为每个关卡标题添加数据属性，用于滚动检测
                    levelHeaderElem.dataset.level = level;
                    
                    wrongAnswersContentElem.appendChild(levelHeaderElem);
                    
                    // 添加该关卡的错题
                    displayWrongAnswersForLevel(level, wrongAnswers, wrongAnswersContentElem);
                }
            });
            
        } catch (error) {
            console.error('显示所有错题失败:', error);
            wrongAnswersContentElem.innerHTML = `
                <div class="error-message">
                    <p>加载错题数据时出错：${error.message}</p>
                    <p>请尝试刷新页面或重新开始学习。</p>
                </div>
            `;
        }
    }
    
    // 创建错题卡片
    function createWrongAnswerItem(question, userAnswer, level, index) {
        let correctAnswer = '';
        let userAnswerText = '';
        
        try {
            // 根据题目类型处理正确答案和用户答案的显示
            if (question.type === 'multiple_choice' || !question.type) {
                // 选择题
                if (question.options && Array.isArray(question.options)) {
                    correctAnswer = question.options[question.correctAnswer] || `选项${question.correctAnswer}`;
                    
                    // 确保userAnswer是有效的数字并且在选项范围内
                    if (typeof userAnswer === 'number' && userAnswer >= 0 && userAnswer < question.options.length) {
                        userAnswerText = question.options[userAnswer] || `选项${userAnswer}`;
                    } else {
                        userAnswerText = '无效答案';
                    }
                } else {
                    correctAnswer = `选项${question.correctAnswer}`;
                    userAnswerText = `选项${userAnswer}`;
                }
            } else if (question.type === 'true_false') {
                // 判断题
                correctAnswer = question.correctAnswer ? '正确' : '错误';
                userAnswerText = (userAnswer === true || userAnswer === 'true') ? '正确' : 
                                (userAnswer === false || userAnswer === 'false') ? '错误' : '无效答案';
            } else if (question.type === 'fill_blank') {
                // 填空题
                correctAnswer = question.correctAnswer || '数据缺失';
                userAnswerText = userAnswer || '未作答';
            } else {
                // 其他未知类型
                correctAnswer = String(question.correctAnswer || '数据缺失');
                userAnswerText = String(userAnswer || '未作答');
            }
        } catch (error) {
            console.error('处理答案显示时出错:', error, {question, userAnswer});
            correctAnswer = '处理答案出错';
            userAnswerText = '处理答案出错';
        }
            
        // 创建错题项
        const wrongAnswerItem = document.createElement('div');
        wrongAnswerItem.className = 'wrong-answer-card';
        wrongAnswerItem.dataset.questionLevel = level;
        wrongAnswerItem.dataset.questionIndex = index;
        
        // 添加序号标记
        const questionNumber = document.createElement('div');
        questionNumber.className = 'question-number';
        questionNumber.textContent = `#${level}-${index + 1}`;
        questionNumber.style.position = 'absolute';
        questionNumber.style.top = '10px';
        questionNumber.style.right = '10px';
        questionNumber.style.color = 'rgba(255, 255, 255, 0.6)';
        questionNumber.style.fontSize = '0.9rem';
        wrongAnswerItem.appendChild(questionNumber);
            
        // 题目标题 - 使用innerHTML支持HTML格式
        const questionTitle = document.createElement('div');
        questionTitle.className = 'question-title';
        questionTitle.innerHTML = question.question || `题目 #${index + 1}`;
        wrongAnswerItem.appendChild(questionTitle);
        
        // 如果是选择题，显示所有选项
        if (question.type === 'multiple_choice' && question.options && Array.isArray(question.options)) {
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'options-container';
            
            question.options.forEach((option, optIndex) => {
                const optionItem = document.createElement('div');
                optionItem.className = 'option-item';
                
                // 标记用户选择的选项和正确选项
                if (optIndex === userAnswer) {
                    optionItem.classList.add('user-selected');
                }
                if (optIndex === question.correctAnswer) {
                    optionItem.classList.add('correct');
                }
                
                optionItem.innerHTML = `${String.fromCharCode(65 + optIndex)}. ${option}`;
                optionsContainer.appendChild(optionItem);
            });
            
            wrongAnswerItem.appendChild(optionsContainer);
        }
            
        // 用户答案
        const userAnswerDiv = document.createElement('div');
        userAnswerDiv.className = 'your-answer';
        userAnswerDiv.innerHTML = `<strong>你的答案:</strong> ${userAnswerText || '未作答'}`;
        wrongAnswerItem.appendChild(userAnswerDiv);
            
        // 正确答案
        const correctAnswerDiv = document.createElement('div');
        correctAnswerDiv.className = 'correct-answer';
        correctAnswerDiv.innerHTML = `<strong>正确答案:</strong> ${correctAnswer}`;
        wrongAnswerItem.appendChild(correctAnswerDiv);
            
        // 解释 - 改进解析显示
        if (question.explanation && question.explanation !== '题目详细数据缺失' && question.explanation !== '题目解释缺失') {
            const explanationDiv = document.createElement('div');
            explanationDiv.className = 'explanation';
            explanationDiv.innerHTML = `<strong>解析:</strong> ${question.explanation}`;
            wrongAnswerItem.appendChild(explanationDiv);
        } else {
            // 如果没有解析或解析数据缺失，显示友好的提示信息
            const explanationDiv = document.createElement('div');
            explanationDiv.className = 'explanation missing-explanation';
            explanationDiv.innerHTML = `<strong>解析:</strong> <span style="color: rgba(255,255,255,0.6);">该题暂无解析说明</span>`;
            wrongAnswerItem.appendChild(explanationDiv);
        }
            
        return wrongAnswerItem;
    }

    // 获取关卡标题
    function getLevelTitle(level) {
        // 尝试从配置中获取标题
        if (window.levelsConfig && window.levelsConfig.levels) {
            // 从配置数组中查找对应关卡
            const levelConfig = window.levelsConfig.levels.find(config => config.level === level);
            if (levelConfig) {
                return levelConfig.title;
            }
        }
        
        // 默认标题
        const titles = {
            1: "Python简介",
            2: "变量与赋值",
            3: "基本输入输出",
            4: "运算符",
            5: "注释与文档",
            6: "数字类型",
            7: "字符串操作",
            8: "列表与元组",
            9: "字典",
            10: "集合",
            11: "条件语句",
            12: "for循环",
            13: "while循环",
            14: "循环控制",
            15: "异常处理",
            16: "函数定义",
            17: "参数与返回值",
            18: "作用域",
            19: "模块导入",
            20: "包管理",
            21: "类与对象",
            22: "继承与多态",
            23: "装饰器",
            24: "生成器",
            25: "文件处理"
        };
        return titles[level] || `关卡 ${level}`;
    }

    // 关卡配置
    window.levelsConfig = {
        totalLevels: 25,
        levels: []
    };
    
    // 加载关卡配置文件
    function loadLevelsConfig() {
        console.log("错题页面: 加载关卡配置文件...");
        
        return fetch('levels-config.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`配置文件加载失败: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(config => {
                console.log("成功加载关卡配置:", config);
                window.levelsConfig = config;
                
                // 更新已经加载的关卡标题
                updateLevelTitles();
                
                return config;
            })
            .catch(error => {
                console.error("加载关卡配置失败:", error);
                console.log("使用默认配置...");
                initDefaultLevelsConfig();
                return window.levelsConfig;
            });
    }
    
    // 初始化默认关卡配置
    function initDefaultLevelsConfig() {
        window.levelsConfig = {
            totalLevels: 25,
            levels: []
        };
        
        // 生成默认关卡配置
        for (let i = 1; i <= 25; i++) {
            let title = "";
            const titles = {
                1: "Python简介",
                2: "变量与赋值",
                3: "基本输入输出",
                4: "运算符",
                5: "注释与文档",
                6: "数字类型",
                7: "字符串操作",
                8: "列表与元组",
                9: "字典",
                10: "集合",
                11: "条件语句",
                12: "for循环",
                13: "while循环",
                14: "循环控制",
                15: "异常处理",
                16: "函数定义",
                17: "参数与返回值",
                18: "作用域",
                19: "模块导入",
                20: "包管理",
                21: "类与对象",
                22: "继承与多态",
                23: "装饰器",
                24: "生成器",
                25: "文件处理"
            };
            title = titles[i] || `关卡 ${i}`;
            
            window.levelsConfig.levels.push({
                level: i,
                title: title,
                description: `完成关卡 ${i} 的挑战`
            });
        }
    }
    
    // 更新已加载的关卡标题
    function updateLevelTitles() {
        // 更新关卡选择器中的标题
        const levelSelect = document.getElementById('level-select');
        if (levelSelect) {
            const options = levelSelect.querySelectorAll('option');
            options.forEach(option => {
                const level = parseInt(option.value);
                if (!isNaN(level)) {
                    option.textContent = `第${level}关 - ${getLevelTitle(level)}`;
                }
            });
        }
        
        // 更新当前显示的关卡标题
        const currentLevel = getCurrentLevel();
        if (currentLevel) {
            const levelHeader = document.getElementById('level-header');
            if (levelHeader) {
                levelHeader.innerHTML = `<h2>第${currentLevel}关 - ${getLevelTitle(currentLevel)}</h2>`;
            }
        }
    }
    
    // 获取当前显示的关卡
    function getCurrentLevel() {
        const urlParams = new URLSearchParams(window.location.search);
        const levelParam = urlParams.get('level');
        return levelParam ? parseInt(levelParam) : null;
    }

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 检查URL参数，获取关卡ID和来源
        const urlParams = new URLSearchParams(window.location.search);
        
        currentLevel = parseInt(urlParams.get('level')) || null;
        source = urlParams.get('source') || 'quiz';
        
        // 调试模式
        if (urlParams.get('debug') === 'true') {
            document.body.classList.add('debug-mode');
            addDebugControls();
        }
        
        // 先加载配置文件
        loadLevelsConfig().then(() => {
            console.log("关卡配置加载完成，开始加载错题...");
            
            // 再加载错题数据
            loadWrongQuestions();
            
            // 显示当前关卡信息
            if (currentLevel) {
                document.getElementById('current-level').textContent = currentLevel;
                const levelHeader = document.getElementById('level-header');
                if (levelHeader) {
                    levelHeader.innerHTML = `<h2>第${currentLevel}关 - ${getLevelTitle(currentLevel)}</h2>`;
                }
            }
        }).catch(error => {
            console.error("配置加载失败:", error);
            
            // 即使配置加载失败，仍然加载错题
            loadWrongQuestions();
        });
        
        // 初始化返回按钮
        const backButton = document.getElementById('back-button');
        if (backButton) {
            backButton.addEventListener('click', function() {
                if (source === 'quiz') {
                    // 从答题页来，返回到答题页
                    window.location.href = currentLevel ? `quiz.html?level=${currentLevel}` : 'index.html';
                } else {
                    // 从首页来，返回首页
                    window.location.href = 'index.html';
                }
            });
        }
    });

    // 加载错题数据
    function loadWrongQuestions() {
        console.log("加载错题数据...");
        try {
            // 从本地存储获取错题数据
            const wrongQuestionsData = JSON.parse(localStorage.getItem('wrong-questions-data')) || { wrongQuestions: {} };
            
            // 添加调试信息 - 详细输出当前错题数据
            console.log("当前错题数据:", JSON.stringify(wrongQuestionsData, null, 2));
            
            // 添加调试信息到页面
            const wrongAnswersContent = document.getElementById('wrongAnswersContent');
            if (wrongAnswersContent) {
                const debugInfo = document.createElement('div');
                debugInfo.className = 'debug-info';
                debugInfo.style.display = 'block'; // 始终显示调试信息
                debugInfo.innerHTML = `错题数据:<br>关卡数: ${Object.keys(wrongQuestionsData.wrongQuestions).length}<br>`;
                
                // 显示每个关卡的错题数量
                Object.keys(wrongQuestionsData.wrongQuestions).forEach(level => {
                    const wrongAnswers = wrongQuestionsData.wrongQuestions[level] || [];
                    debugInfo.innerHTML += `关卡${level}: ${wrongAnswers.length}道错题<br>`;
                    
                    // 列出错题标题
                    if (wrongAnswers.length > 0) {
                        debugInfo.innerHTML += "<ul>";
                        wrongAnswers.forEach(item => {
                            debugInfo.innerHTML += `<li>${item.questionKey.substring(0, 30)}...</li>`;
                        });
                        debugInfo.innerHTML += "</ul>";
                    }
                });
                
                wrongAnswersContent.appendChild(debugInfo);
            }
            
            // 检查错题数据是否存在
            const levelsWithWrongAnswers = Object.keys(wrongQuestionsData.wrongQuestions)
                .filter(level => {
                    const wrongAnswers = wrongQuestionsData.wrongQuestions[level] || [];
                    return wrongAnswers.length > 0;
                });
            
            console.log(`检测到${levelsWithWrongAnswers.length}个关卡的错题记录:`, levelsWithWrongAnswers);
            
            // 如果没有错题数据，显示提示信息
            if (levelsWithWrongAnswers.length === 0) {
                const wrongAnswersContent = document.getElementById('wrongAnswersContent');
                wrongAnswersContent.innerHTML = '';
                
                const noWrongAnswers = document.createElement('div');
                noWrongAnswers.className = 'no-wrong-answers';
                noWrongAnswers.textContent = '太棒了！你在所有关卡中都没有错题！';
                wrongAnswersContent.appendChild(noWrongAnswers);
                
                // 隐藏关卡标签和选择器
                const levelSubtitle = document.getElementById('level-subtitle');
                if (levelSubtitle) levelSubtitle.style.display = 'none';
            } else {
                // 初始化关卡选择器
                initLevelSelector();
                
                // 直接显示所有关卡的错题，不等待用户选择
                displayAllWrongAnswers();
            }
            
            // 根据来源设置UI
            setupUIBasedOnSource();
            
        } catch (error) {
            console.error("加载错题数据失败:", error);
            const wrongAnswersContent = document.getElementById('wrongAnswersContent');
            
            if (wrongAnswersContent) {
                wrongAnswersContent.innerHTML = '';
                const errorMessage = document.createElement('div');
                errorMessage.className = 'error-message';
                errorMessage.textContent = `加载错题数据时出错: ${error.message}`;
                wrongAnswersContent.appendChild(errorMessage);
            }
        }
    }

    // 初始化关卡选择器
    function initLevelSelector() {
        const levelSelect = document.getElementById('level-select');
        if (!levelSelect) return;
        
        // 获取关卡标题元素
        const levelSubtitle = document.getElementById('level-subtitle');
        
        // 添加调试信息容器
        const debugInfo = document.createElement('div');
        debugInfo.className = 'debug-info';
        document.getElementById('wrongAnswersContent').innerHTML = '';
        document.getElementById('wrongAnswersContent').appendChild(debugInfo);
        
        debugInfo.innerHTML = `正在初始化关卡选择器...<br>
            - 正在从 localStorage 加载错题数据...`;
        
        try {
            // 正确获取错题数据
            const wrongQuestionsData = JSON.parse(localStorage.getItem('wrong-questions-data')) || { wrongQuestions: {} };
            
            // 获取包含错题的所有关卡
            const levelsWithWrongAnswers = Object.keys(wrongQuestionsData.wrongQuestions)
                .filter(level => {
                    const wrongAnswers = wrongQuestionsData.wrongQuestions[level] || [];
                    return wrongAnswers.length > 0;
                })
                .map(level => parseInt(level))
                .sort((a, b) => a - b);
            
            debugInfo.innerHTML = `关卡选择器初始化：<br>
                - 包含错题的关卡数：${levelsWithWrongAnswers.length}<br>
                - 关卡列表：[${levelsWithWrongAnswers.join(', ')}]<br>
                - 最后更新时间：${wrongQuestionsData.lastUpdated || '未知'}`;
            
            // 清空现有选项
            while (levelSelect.firstChild) {
                levelSelect.removeChild(levelSelect.firstChild);
            }
            
            // 添加"所有关卡"选项
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = '默认显示所有关卡';
            levelSelect.appendChild(allOption);
            
            // 填充关卡选择器
            levelsWithWrongAnswers.forEach(level => {
                const option = document.createElement('option');
                option.value = level;
                option.textContent = `第${level}关 - ${getLevelTitle(level)}`;
                levelSelect.appendChild(option);
            });
            
            // 设置初始选中值
            if (source === 'home') {
                levelSelect.value = 'all';
            } else {
                // 检查当前关卡是否有错题
                if (levelsWithWrongAnswers.includes(currentLevel)) {
                    levelSelect.value = currentLevel;
                } else {
                    levelSelect.value = 'all';
                }
            }
            
            // 添加选择事件
            levelSelect.addEventListener('change', function() {
                const selectedLevel = this.value;
                
                if (selectedLevel === 'all') {
                    // 显示所有关卡错题
                    if (levelSubtitle) levelSubtitle.style.display = 'none';
                    displayAllWrongAnswers();
                } else {
                    // 显示特定关卡错题，始终隐藏关卡标题
                    const level = parseInt(selectedLevel);
                    const currentLevelElem = document.getElementById('current-level');
                    if (currentLevelElem) currentLevelElem.textContent = level;
                    // 无论选择哪个关卡，都隐藏小标题
                    if (levelSubtitle) levelSubtitle.style.display = 'none';
                    displayWrongAnswersByLevel(level);
                }
            });
            
            // 触发初始显示
            levelSelect.dispatchEvent(new Event('change'));
            
        } catch (error) {
            console.error('初始化关卡选择器失败:', error);
            debugInfo.innerHTML = `<strong style="color: #ff375f">初始化关卡选择器失败：${error.message}</strong>`;
        }
    }

    // 显示指定关卡的错题（在特定容器内）
    function displayWrongAnswersForLevel(level, wrongAnswers, container) {
        try {
            // 如果没有错题，显示提示
            if (wrongAnswers.length === 0) {
                const noWrongAnswers = document.createElement('div');
                noWrongAnswers.className = 'no-wrong-answers';
                noWrongAnswers.textContent = `太棒了！第${level}关你没有错题！`;
                container.appendChild(noWrongAnswers);
                return;
            }
            
            // 获取题库数据
            let levelQuestions = questionBank[level] || [];
            
            // 确保题库数据存在
            if (levelQuestions.length === 0) {
                console.warn(`关卡 ${level} 的题库数据不存在，尝试从错题中恢复`);
                
                // 尝试从错题记录中恢复题目
                wrongAnswers.forEach(item => {
                    if (item.questionKey) {
                        const recoveredQuestion = {
                            question: item.questionKey,
                            type: item.questionType || 'multiple_choice',
                            correctAnswer: item.correctAnswer,
                            options: item.options || ['选项内容缺失'],
                            explanation: item.explanation || '该题暂无解析说明'
                        };
                        levelQuestions.push(recoveredQuestion);
                    }
                });
            }
            
            // 显示错题
            let displayedCount = 0;
            wrongAnswers.forEach((item, index) => {
                // 尝试找到题目详细信息
                let question = null;
                
                // 通过问题文本查找
                if (item.questionKey) {
                    question = levelQuestions.find(q => q.question === item.questionKey);
                }
                
                // 如果找不到，创建临时题目对象
                if (!question) {
                    let tempOptions = [];
                    if (item.options && Array.isArray(item.options)) {
                        tempOptions = item.options;
                    } else if (typeof item.userAnswer === 'number' && item.questionType !== 'true_false') {
                        tempOptions = Array(Math.max(4, item.userAnswer + 1)).fill('选项内容缺失');
                        if (typeof item.correctAnswer === 'number') {
                            tempOptions = Array(Math.max(tempOptions.length, item.correctAnswer + 1)).fill('选项内容缺失');
                        }
                    }
                    
                    question = {
                        question: item.questionKey || `题目 #${index + 1}`,
                        type: item.questionType || 
                              (typeof item.userAnswer === 'boolean' ? 'true_false' : 
                               typeof item.userAnswer === 'number' ? 'multiple_choice' : 'fill_blank'),
                        options: tempOptions,
                        correctAnswer: item.correctAnswer !== undefined ? item.correctAnswer : '数据缺失',
                        explanation: item.explanation || '该题暂无解析说明'
                    };
                }
                
                // 创建错题卡片并添加到容器
                const wrongAnswerItem = createWrongAnswerItem(question, item.userAnswer, level, index);
                container.appendChild(wrongAnswerItem);
                displayedCount++;
            });
            
            // 如果没有成功显示任何错题，显示错误信息
            if (displayedCount === 0 && wrongAnswers.length > 0) {
                const errorMessage = document.createElement('div');
                errorMessage.className = 'error-message';
                errorMessage.textContent = `虽然存在${wrongAnswers.length}个错题记录，但无法显示。可能是题库数据与错题记录不匹配。`;
                container.appendChild(errorMessage);
            }
            
        } catch (error) {
            console.error('显示关卡错题失败:', error, {level, wrongAnswers});
            const errorMessage = document.createElement('div');
            errorMessage.className = 'error-message';
            errorMessage.textContent = `显示第${level}关错题时出错: ${error.message}`;
            container.appendChild(errorMessage);
        }
    }

    // 添加修复下拉菜单问题的脚本
    document.addEventListener('DOMContentLoaded', function() {
        const levelSelector = document.querySelector('.level-selector');
        const levelSelect = document.getElementById('level-select');
        
        if (levelSelector && levelSelect) {
            // 添加选择器的鼠标离开事件
            levelSelector.addEventListener('mouseleave', function() {
                // 关闭下拉菜单
                levelSelect.blur();
            });
            
            // 确保选择后立即关闭下拉菜单
            levelSelect.addEventListener('change', function() {
                this.blur();
            });
        }
    });

    // 初始化错题集
    function initWrongAnswers() {
        // 获取当前关卡参数
        const urlParams = new URLSearchParams(window.location.search);
        const level = urlParams.get('level');
        
        // 如果指定了关卡，只显示该关卡的错题
        if (level) {
            displayWrongAnswersByLevel(level);
        } else {
            // 否则显示所有关卡的错题
            displayAllWrongAnswers();
        }
        
        // 添加滚动监听，处理粘性标题效果
        initStickyHeaders();
    }
    
    // 初始化粘性标题效果
    function initStickyHeaders() {
        // 获取错题内容容器
        const contentContainer = document.getElementById('wrongAnswersContent');
        if (!contentContainer) return;
        
        // 滚动事件处理
        contentContainer.addEventListener('scroll', function() {
            // 获取所有关卡标题
            const headers = contentContainer.querySelectorAll('.level-header');
            if (!headers.length) return;
            
            // 获取当前可视区域位置
            const scrollTop = contentContainer.scrollTop;
            
            // 跟踪当前可见的标题
            let currentVisible = null;
            let smallestDistance = Infinity;
            
            // 检查哪个标题最接近视口顶部
            headers.forEach(header => {
                // 获取标题相对于容器的位置
                const headerTop = header.offsetTop - contentContainer.offsetTop;
                // 计算标题与视口顶部的距离（如果标题在视口上方，距离为负）
                const distance = headerTop - scrollTop;
                
                // 我们主要关注那些已经滚动到视口上方的标题（距离小于等于0）
                // 但是距离最接近0的那个是我们要的"当前标题"
                if (distance <= 0 && Math.abs(distance) < smallestDistance) {
                    smallestDistance = Math.abs(distance);
                    currentVisible = header;
                }
            });
            
            // 高亮当前可见的标题
            if (currentVisible) {
                headers.forEach(h => {
                    // 移除所有标题的高亮效果
                    h.classList.remove('active-header');
                });
                // 为当前标题添加高亮效果
                currentVisible.classList.add('active-header');
            }
        });
        
        // 初始触发一次滚动事件，设置初始状态
        contentContainer.dispatchEvent(new Event('scroll'));
    }

    // 在现有脚本末尾添加调整函数
    function adjustTitlePosition(offset) {
        document.documentElement.style.setProperty('--title-vertical-offset', offset + 'px');
    }
    
    // 默认调整，可以根据需要更改数值
    adjustTitlePosition(5); // 向下偏移5像素，可根据实际效果调整
    
    // 添加键盘控制，允许用户调整垂直位置
    let currentOffset = 5;
    document.addEventListener('keydown', function(e) {
        // 上箭头键 - 向上移动文字
        if (e.key === 'ArrowUp') {
            currentOffset -= 1;
            adjustTitlePosition(currentOffset);
            console.log('文字垂直位置: ' + currentOffset + 'px');
        }
        // 下箭头键 - 向下移动文字
        else if (e.key === 'ArrowDown') {
            currentOffset += 1;
            adjustTitlePosition(currentOffset);
            console.log('文字垂直位置: ' + currentOffset + 'px');
        }
    });
</script>
</body>
</html> 
